name: Release
on:
  push:
    tags: [ "v*" ]

env:
  CARGO_TERM_COLOR: always
defaults:
  run:
    shell: bash
jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ferrumc-test"
      - name: Run cargo fmt
        run: cargo fmt --all -- --check
      - name: Run Clippy
        run: cargo clippy --all-targets -- -D warnings
      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest
      - name: Run Tests
        run: cargo nextest run --target x86_64-unknown-linux-gnu --all-targets --all-features -E "not kind(bench)"

  build-release:
    name: Build Release (${{ matrix.target }})
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-14
            target: aarch64-apple-darwin
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "ferrumc"
      - name: Build
        run: cargo build --profile production --target ${{ matrix.target }} --all-features
      - name: Package (Linux/macOS)
        if: runner.os != 'Windows'
        run: tar -czf ferrumc-${{ github.ref_name }}-${{ matrix.target }}.tar.gz -C target/${{ matrix.target }}/production ferrumc
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Compress-Archive -Path target/${{ matrix.target }}/production/ferrumc.exe -DestinationPath ferrumc-${{ github.ref_name }}-${{ matrix.target }}.zip
      - name: Checksum (Linux)
        if: runner.os == 'Linux'
        run: sha256sum ferrumc-${{ github.ref_name }}-${{ matrix.target }}.tar.gz > ferrumc-${{ github.ref_name }}-${{ matrix.target }}.tar.gz.sha256
      - name: Checksum (macOS)
        if: runner.os == 'macOS'
        run: shasum -a 256 ferrumc-${{ github.ref_name }}-${{ matrix.target }}.tar.gz > ferrumc-${{ github.ref_name }}-${{ matrix.target }}.tar.gz.sha256
      - name: Checksum (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: (Get-FileHash ferrumc-${{ github.ref_name }}-${{ matrix.target }}.zip -Algorithm SHA256).Hash.ToLower() + "  ferrumc-${{ github.ref_name }}-${{ matrix.target }}.zip" | Out-File -Encoding ascii ferrumc-${{ github.ref_name }}-${{ matrix.target }}.zip.sha256
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ferrumc-${{ matrix.target }}
          path: |
            ferrumc-${{ github.ref_name }}-${{ matrix.target }}.*

  publish:
    name: Publish Release
    needs: build-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            ferrumc-*.tar.gz
            ferrumc-*.zip
            ferrumc-*.sha256
